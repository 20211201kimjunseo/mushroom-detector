<script>
  const mURL = "https://teachablemachine.withgoogle.com/models/P0aEmmNoR/";
  let mdl;

  async function init() {
    try {
      mdl = await tmImage.load(mURL + "model.json", mURL + "metadata.json");
    } catch (e) {
      desc.innerText = "모델 로딩 실패";
      console.error(e);
    }
  }

  function info(label) {
    const d = {
      "Galerina marginata":
`• 독성: α,γ‑amanitin (간·신장 급손상)
• 잠복: 6‑12h → 구토·설사 → 급성 간부전
• 사망률: 치료 지연 시 50‑90%
• 고위험군: 소아·노인·간질환자 절대 금기`,
      "Amanita muscaria":
`• 독성: ibotenic acid, muscimol (신경계 자극/억제)
• 증상: 30min‑3h 후 환각·어지럼·구토·혼수 가능
• 사망률: 희귀하지만 농축·건조 섭취 시 심각 사례
• 주의: 소아·정신질환자·환각 목적으로 금기`,
      "Amanita brunnescens":
`• 독성: 불명 (“possibly poisonous”)
• 특징: Amanita 속 형태와 혼동 매우 쉬움
• 주의: 전문가 확인 전 절대 섭취 금지`,
      "Hericium erinaceus":
`• 영양: β-glucan, hericenones, erinacines, 비타민 B냉
• 효능: NGF 촉진→인지 강화, 면역↑, 항염·항산화
• 주의: 혈당·항응고제 복용자·장민감자 서서히 섭취`,
      "Pleurotus ostreatus":
`• 영양: 저칼로리·고단백·식이섬유 풍부 (B3 27%)
• 효능: 항산화·심혈관 보호·면역조절·항암 가능성
• 주의: 일반 식용, 특이 알러지 없으면 안전`
    };
    return d[label] || "정보 없음";
  }

  const inp = document.getElementById("imageUpload");
  const prev = document.getElementById("preview");
  const res = document.getElementById("result");
  const desc = document.getElementById("description");

  inp.addEventListener("change", async e => {
    const a = e.target.files[0];
    if (!a) return;
    const r = new FileReader();
    r.onload = ev => {
      const img = new Image();
      img.onload = async () => {
        prev.src = img.src;
        res.innerText = "예측 중...";
        try {
          const p = await mdl.predict(img);
          const b = p.sort((x,y)=>y.probability-x.probability)[0];
          res.innerText = `예측: ${b.className} ${(b.probability*100).toFixed(1)}%`;
          desc.innerText = info(b.className);
        } catch (e2) {
          desc.innerText = "예측 실패";
          console.error(e2);
        }
      };
      img.src = ev.target.result;
    };
    r.readAsDataURL(a);
  });

  init();
</script>
